{% extends "base.html" %}

{% block content %}
  <h1 class="page-title">Credentials (secure_auth.users)</h1>
  <p class="page-subtitle">
    Manage usernames and passwords that can access this DBMS.  
    Password updates here will be stored as hashes.
  </p>

  <div class="grid grid-2">
    <div class="card">
      <div class="badge">Add credential</div>
      <form method="POST" action="{{ url_for('add_cred_view') }}" style="margin-top:0.4rem;">
        <div>
          <label for="username">Username</label>
          <input id="username" name="username" required />
        </div>
        <div>
          <label for="password">Password</label>
          <input id="password" name="password" type="password" required />
        </div>
        <div>
          <label for="role">Role</label>
          <select id="role" name="role">
            <option value="admin">admin</option>
            <option value="user" selected>user</option>
          </select>
        </div>
        <button class="btn btn-primary" type="submit" style="margin-top:0.3rem;align-self:flex-end;">
          Add
        </button>
      </form>
    </div>

    <div class="card">
      <div class="badge">Existing users</div>
      <p class="muted" style="margin-top:0.3rem;">Update role and username. Leave password empty to keep it unchanged.</p>

      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Role</th>
            <th style="width:150px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr>
              <td colspan="3">
                <form method="POST" action="{{ url_for('update_cred_view', user_id=u._id) }}"
                      style="display:flex;align-items:center;gap:0.4rem;">
                  <input name="username" value="{{ u.username }}" style="max-width:140px;" />
                  <input name="password" type="password" placeholder="new password (optional)" style="max-width:170px;" />
                  <select name="role" style="max-width:100px;">
                    <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>admin</option>
                    <option value="user" {% if u.role != 'admin' %}selected{% endif %}>user</option>
                  </select>
                  <button class="btn btn-primary" type="submit" style="padding-inline:0.8rem;">Save</button>
                </form>
                <form method="POST"
                      action="{{ url_for('delete_cred_view', user_id=u._id) }}"
                      onsubmit="return confirm('Delete user {{ u.username }}?');"
                      style="margin-top:0.3rem;">
                  <button class="btn btn-ghost" type="submit" style="border-color:rgba(248,113,113,0.7);color:#fecaca;">
                    Delete
                  </button>
                </form>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="3" class="muted">No users found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
